{% extends 'base.html' %}
{% block content %}
<div class="d-flex flex-wrap align-items-center mb-3 gap-3">
  <div>
    <h3 class="mb-0">AI Diagnostics</h3>
    <small class="text-muted">Deterministic insights powered by on-device data</small>
  </div>
  <div class="ms-auto text-end">
    <div class="text-muted small">Device</div>
    <div class="fw-semibold" id="aiDeviceLabel">{{ selected_device_id or 'No device' }}</div>
  </div>
</div>

{% if not selected_device_id %}
<div class="alert alert-info">No device selected. Claim or pick a device from the selector to see AI insights.</div>
{% endif %}

<div class="row g-3 mb-3">
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fa-solid fa-notes-medical me-2"></i>System Health</span>
        <small class="text-muted" id="aiGeneratedAt">--</small>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <div class="d-flex justify-content-between"><span>Dust probability</span><span id="dustValue">--</span></div>
          <div class="progress"><div class="progress-bar bg-warning" id="dustBar" style="width:0%"></div></div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between"><span>Shading probability</span><span id="shadingValue">--</span></div>
          <div class="progress"><div class="progress-bar bg-info" id="shadingBar" style="width:0%"></div></div>
        </div>
        <div>
          <div class="d-flex justify-content-between"><span>Sensor health</span><span id="sensorHealthValue">--</span></div>
          <div class="progress"><div class="progress-bar bg-success" id="sensorHealthBar" style="width:0%"></div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header"><i class="fa-solid fa-triangle-exclamation me-2"></i>Alerts</div>
      <div class="card-body" id="alertsPanel">
        <div class="text-muted">No active alerts.</div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header"><i class="fa-solid fa-lightbulb me-2"></i>Next Hour Forecast</div>
      <div class="card-body">
        <div class="display-6" id="forecastValue">-- Wh</div>
        <div class="text-muted">Confidence: <span id="forecastConfidence">--</span>%</div>
        <hr>
        <div class="d-flex justify-content-between"><span>Efficiency score</span><span id="efficiencyScore">--</span></div>
        <div class="progress"><div class="progress-bar bg-primary" id="efficiencyBar" style="width:0%"></div></div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header"><i class="fa-solid fa-spell-check me-2"></i>Decision Explainer</div>
      <div class="card-body">
        <div class="ai-content" id="explainerText">Awaiting explanation from Gemini.</div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header"><i class="fa-solid fa-list-check me-2"></i>Recommendations</div>
      <div class="card-body" id="recommendationsList">
        <div class="text-muted">No recommendations yet.</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fa-solid fa-shield-halved me-2"></i>Device Reliability</span>
        <small class="text-muted">Auto-refresh every 60s</small>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <canvas id="resetChart" height="120"></canvas>
          </div>
          <div class="col-md-6">
            <div class="mb-2 d-flex justify-content-between"><span>Power rail risk</span><span id="powerRailRiskLabel">--</span></div>
            <div class="progress mb-3"><div class="progress-bar bg-danger" id="powerRailRiskBar" style="width:0%"></div></div>
            <div class="mb-2 d-flex justify-content-between"><span>RTC reliability</span><span id="rtcScoreLabel">--</span></div>
            <div class="progress"><div class="progress-bar bg-success" id="rtcScoreBar" style="width:0%"></div></div>
          </div>
        </div>
        <hr>
        <div>
          <div class="fw-semibold mb-2">Fault timeline</div>
          <ul class="list-group" id="faultTimeline"></ul>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header"><i class="fa-solid fa-circle-info me-2"></i>Today Stats</div>
      <div class="card-body" id="todayStats">
        <div class="d-flex justify-content-between mb-2"><span>Energy today</span><span id="todayEnergy">-- Wh</span></div>
        <div class="d-flex justify-content-between mb-2"><span>Move count</span><span id="todayMoves">--</span></div>
        <div class="d-flex justify-content-between mb-2"><span>Best slot power</span><span id="bestSlotPower">-- W</span></div>
        <div class="d-flex justify-content-between"><span>Wasted moves</span><span id="wastedMoves">-- %</span></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/ai_dashboard.js') }}"></script>
{% endblock %}
